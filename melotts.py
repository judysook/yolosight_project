# -*- coding: utf-8 -*-
"""MeloTTS.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/11yWq9zgAr95GgE8iGZXrQiSjAXLSdT08
"""

# Commented out IPython magic to ensure Python compatibility.
# ëŸ°íƒ€ì„ ìœ í˜• ë³€ê²½ > í•˜ë“œì›¨ì–´ ê°€ì†ê¸°: GPU ì„ íƒ

# ê¸°ë³¸ ë„êµ¬ ì„¤ì¹˜
!sudo apt-get update -y
!sudo apt-get install -y libsndfile1 ffmpeg

# git clone
!git clone https://github.com/judysook/yolosight_project.git
# %cd yolosight_project

!rm -rf /usr/local/lib/python3.11/dist-packages/~umpy*

# ë˜ëŠ” ì§ì ‘ í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
!pip install torch torchaudio tensorboard einops librosa
!pip install -U matplotlib numpy scipy tqdm

!pip install numpy==1.26.4

# 2. ê¸°ë³¸ pip íŒ¨í‚¤ì§€ ì„¤ì¹˜ (MeloTTS ê¸°ë°˜)
!pip install -U pip wheel setuptools
!pip install torch torchaudio
!pip install numpy librosa matplotlib pyyaml soundfile scipy tqdm

# 3. (ì˜µì…˜) Web UI ì‚¬ìš© ì‹œ
!pip install gradio flask

# 4. í•™ìŠµìš© ë°ì´í„° ì „ì²˜ë¦¬
# ì˜ˆ: yolosight_project/melo/data/example/metadata.list íŒŒì¼ì„ ì´ìš©
!python melo/preprocess_text.py --metadata melo/data/example/metadata.list

# 5. í•™ìŠµ ì‹¤í–‰ (config íŒŒì¼ í•„ìš”)
# ì˜ˆ: config.json ê²½ë¡œë¥¼ ì•„ë˜ì²˜ëŸ¼ ì„¤ì • (íŒŒì¼ ê²½ë¡œì— ë”°ë¼ ìˆ˜ì • ê°€ëŠ¥)
!python melo/train.py --config melo/data/example/config.json

!pwd

# ê¸°ë³¸ íŒ¨í‚¤ì§€ (ì´ë¯¸ ëŒ€ë¶€ë¶„ ì„¤ì¹˜ë˜ì–´ ìˆìŒ)
!pip install numpy==1.26.4 scipy==1.15.3 librosa==0.11.0 matplotlib==3.10.3 tqdm soundfile pyyaml

# TTS ê´€ë ¨
!pip install torch torchaudio transformers phonemizer g2p-en g2pkk inflect pypinyin unidecode regex

# í…ìŠ¤íŠ¸ ì „ì²˜ë¦¬, íŒŒì¼ ê´€ë¦¬
!pip install nltk opencv-python jamo loguru

# AWSì™€ huggingface ì—°ë™
!pip install boto3 s3transfer huggingface-hub safetensors

# ì›¹ ì¸í„°í˜ì´ìŠ¤
!pip install gradio flask fastapi

# ê¸°íƒ€ ìœ í‹¸ë¦¬í‹°
!pip install pyqtgraph rich click

import nltk
nltk.download('punkt')  # MeloTTSê°€ ì“¸ ìˆ˜ ìˆìŒ

!pip install jamo

# 1. sys.path ì¶”ê°€
import sys
sys.path.append('/content/drive/MyDrive/Colab Notebooks/MeloTTS-main')

# Commented out IPython magic to ensure Python compatibility.
# Colab ì´ˆê¸° ê²½ë¡œë¡œ ì´ë™
# %cd /content

# Drive ë§ˆìš´íŠ¸
from google.colab import drive
drive.mount('/content/drive')

# Commented out IPython magic to ensure Python compatibility.
##ì „ì²˜ë¦¬
# !python "/content/drive/MyDrive/Colab Notebooks/MeloTTS-main/melo/preprocess_text.py" \
#   --metadata "./metadata.list"
!pip install jamo phonemizer librosa textgrid

# %cd /content/drive/MyDrive/Colab Notebooks/MeloTTS-main/melo
!python preprocess_text.py --metadata metadata.list

# Commented out IPython magic to ensure Python compatibility.
#ì—¬ê¸°ë¶€í„° ì—ëŸ¬.
## í•™ìŠµ
# 1. ë””ë ‰í† ë¦¬ ì´ë™
# %cd '/content/drive/MyDrive/Colab Notebooks/MeloTTS-main'

# 2. ê²½ë¡œ ë“±ë¡
import sys
sys.path.append(".")

# 3. í•™ìŠµ ì‹¤í–‰ (ì ˆëŒ€ê²½ë¡œ âŒ, ìƒëŒ€ê²½ë¡œ â­•)
#!python melo/train.py --config_path melo/config.json
import json

with open("melo/config.json", "r", encoding="utf-8") as f:
    config = json.load(f)

config['data']['training_files'] = "/content/drive/MyDrive/Colab Notebooks/MeloTTS-main/melo/train.list"
config['data']['validation_files'] = "/content/drive/MyDrive/Colab Notebooks/MeloTTS-main/melo/val.list"

with open("melo/config.json", "w", encoding="utf-8") as f:
    json.dump(config, f, indent=2, ensure_ascii=False)

print("âœ… config íŒŒì¼ ê²½ë¡œ ìˆ˜ì • ì™„ë£Œ")

!python melo/train.py --config melo/config.json

import os

train_list_path = "/content/drive/MyDrive/Colab Notebooks/MeloTTS-main/melo/data/example/train.list"

with open(train_list_path, encoding="utf-8") as f:
    for line in f:
        path = line.strip().split("|")[0]
        exists = os.path.exists(path)
        print(f"{path} -> {'âœ… ì¡´ì¬í•¨' if exists else 'âŒ ì—†ìŒ'}")

hop_length = 512
min_text_len = 10
max_text_len = 1000

# with open("melo/data/example/train.list", encoding="utf-8") as f:
#     for line in f:
#         parts = line.strip().split("|")
#         audiopath = parts[0]
#         text = parts[3]  # ë˜ëŠ” 4ë²ˆì§¸ê°€ í…ìŠ¤íŠ¸ì¸ ê²½ìš°
#         length = os.path.getsize(audiopath) // (2 * hop_length)
#         text_len = len(text.split())

#         print(f"ğŸ§ª {audiopath} -> ê¸¸ì´: {length}, í…ìŠ¤íŠ¸ ê¸¸ì´: {text_len}")

#         if length < min_text_len or length > max_text_len:
#             print("âŒ í•„í„°ì— ê±¸ë¦¼")
#         else:
#             print("âœ… í•™ìŠµ í¬í•¨ ëŒ€ìƒ")

with open("melo/data/example/train.list", encoding="utf-8") as f:
    for line in f:
        parts = line.strip().split("|")
        print(f"ğŸ“„ í•­ëª© ê°œìˆ˜: {len(parts)} â†’ {parts}")  # ë””ë²„ê¹…ìš© ì¶œë ¥

        if len(parts) < 4:
            print("âš ï¸ í•­ëª© ë¶€ì¡±: ìŠ¤í‚µë¨")
            continue

        audiopath = parts[0]
        text = parts[3]
        length = os.path.getsize(audiopath) // (2 * hop_length)
        text_len = len(text.split())

        print(f"ğŸ§ª {audiopath} -> ê¸¸ì´: {length}, í…ìŠ¤íŠ¸ ê¸¸ì´: {text_len}")

        if length < min_text_len or length > max_text_len:
            print("âŒ í•„í„°ì— ê±¸ë¦¼")
        else:
            print("âœ… í•™ìŠµ í¬í•¨ ëŒ€ìƒ")

import os

hop_length = 512
min_text_len = 1
max_text_len = 300

with open("melo/data/example/train.list", encoding="utf-8") as f:
    for line in f:
        parts = line.strip().split("|")
        if len(parts) < 4:
            print(f"âš ï¸ í•­ëª© ì´ìƒ: {parts}")
            continue

        audiopath = parts[0]
        text = parts[3]
        text_len = len(text.split())

        try:
            size = os.path.getsize(audiopath)
            length = size // (2 * hop_length)
            print(f"ğŸ“ {audiopath} â†’ íŒŒì¼í¬ê¸°: {size}, frame ìˆ˜: {length}, í…ìŠ¤íŠ¸ ê¸¸ì´: {text_len}")

            if length < min_text_len or length > max_text_len:
                print("âŒ í•„í„°ì— ê±¸ë¦¼")
            else:
                print("âœ… í•™ìŠµ í¬í•¨")
        except Exception as e:
            print(f"ğŸš« getsize ì‹¤íŒ¨: {audiopath} â†’ {e}")

!pwd
!ls '/content/drive/MyDrive/Colab Notebooks/MeloTTS-main/melo/'

# train.list ê²½ë¡œ ì ˆëŒ€ê²½ë¡œë¡œ ë°”ê¾¸ê¸°
train_path = "melo/train.list"

with open(train_path, "r", encoding="utf-8") as f:
    lines = f.readlines()

new_lines = []
for line in lines:
    parts = line.strip().split("|")
    if len(parts) == 3:
        wav_path = parts[0]
        if not wav_path.startswith("/"):
            # ìƒëŒ€ê²½ë¡œë¥¼ ì ˆëŒ€ê²½ë¡œë¡œ ë°”ê¿ˆ
            wav_path = "/content/drive/MyDrive/Colab Notebooks/MeloTTS-main/melo/" + wav_path
        new_lines.append(f"{wav_path}|{parts[1]}|{parts[2]}\n")

# ì‹¤ì œë¡œ íŒŒì¼ì— ë‹¤ì‹œ ì €ì¥
with open(train_path, "w", encoding="utf-8") as f:
    f.writelines(new_lines)

# Commented out IPython magic to ensure Python compatibility.
# 1. Colab ë£¨íŠ¸ ê²½ë¡œë¡œ ì´ë™
# %cd /content

# 2. í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
!pip install jamo

# 3. MeloTTS ì „ì²´ ë³µì‚¬ (í•œ ë²ˆë§Œ!)
#!cp -r "/content/drive/MyDrive/Colab Notebooks/MeloTTS-main/melo" .

# 4. ì „ì²˜ë¦¬ ì‹¤í–‰ (ì˜¬ë°”ë¥¸ ì˜µì…˜ ì‚¬ìš©!)
!python melo/preprocess_text.py --config_path melo/data/example/config.json

# 5. í•™ìŠµ ì‹¤í–‰
!python melo/train.py --config melo/data/example/config.json

# Commented out IPython magic to ensure Python compatibility.

# 1. í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
# %cd /content/drive/MyDrive/Colab Notebooks/MeloTTS-main/melo/data/example

from google.colab import drive
drive.mount('/content/drive')

# 3. Driveì—ì„œ metadata.listì™€ wav íŒŒì¼ë“¤ì´ ë“¤ì–´ìˆëŠ” í´ë” ê²½ë¡œ ì„¤ì •
drive_data_path = "/content/drive/MyDrive/Colab Notebooks/MeloTTS-main/melo/data/example"

# 4. MeloTTS í”„ë¡œì íŠ¸ ë‚´ì˜ í•™ìŠµìš© ë°ì´í„° ê²½ë¡œë¡œ ì—°ê²° (ì‹¬ë³¼ë¦­ ë§í¬)
!rm -rf melo/data/example  # ê¸°ì¡´ example í´ë” ì œê±° (ìˆì„ ê²½ìš°)
!ln -s "{drive_data_path}" melo/data/example

# 5. ì „ì²˜ë¦¬ ì‹¤í–‰
!python melo/preprocess_text.py --metadata melo/data/example/metadata.list

# 6. í•™ìŠµ ì‹¤í–‰ (config.jsonì€ ë“œë¼ì´ë¸Œ ì•ˆì— ìˆë‹¤ê³  ê°€ì •)
!python melo/train.py --config melo/data/example/config.json

from google.colab import drive
drive.mount('/content/drive')







